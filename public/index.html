<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>小王子失去了玫瑰花</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="Java，大数据，算法，Python，Ruby，前端">
<meta property="og:type" content="website">
<meta property="og:title" content="小王子失去了玫瑰花">
<meta property="og:url" content="http://example.com/index.html">
<meta property="og:site_name" content="小王子失去了玫瑰花">
<meta property="og:description" content="Java，大数据，算法，Python，Ruby，前端">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="DiGuang Wu">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="小王子失去了玫瑰花" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
<meta name="generator" content="Hexo 5.4.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">小王子失去了玫瑰花</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">骗你的，没失去~</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main">
  
    <article id="post-java/jvm" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/10/29/java/jvm/" class="article-date">
  <time class="dt-published" datetime="2021-10-29T14:26:47.496Z" itemprop="datePublished">2021-10-29</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="jvm"><a href="#jvm" class="headerlink" title="jvm"></a>jvm</h1><figure class="highlight md"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">author: WuDG</span><br><span class="line">datetime： 17:2831 星期四 2021年8月5日</span><br><span class="line">position： 杭州乐佳大厦/博彦</span><br></pre></td></tr></table></figure>
<blockquote>
<p>我曾七次鄙视自己的灵魂<br>第一次，当它本可进取时，却故作谦卑；<br>第二次，当它在空虚时，用爱欲来填充；<br>第三次，在困难和容易之间，它选择了容易；<br>第四次，它犯了错，却借由别人也会犯错来宽慰自己；<br>第五次，它自由软弱，却把它认为是生命的坚韧；<br>第六次，当它鄙夷一张丑恶的嘴脸时，却不知那正是自己面具中的一副；<br>第七次，它侧身于生活的污泥中，虽不甘心，却又畏首畏尾。 </p>
</blockquote>
<ul>
<li><a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/specs/jvms/se8/html/index.html">JVM 规范</a></li>
<li>《深入理解Java虚拟机（第三版）》</li>
</ul>
<h2 id="一、Java-内存区域（运行时数据区）"><a href="#一、Java-内存区域（运行时数据区）" class="headerlink" title="一、Java 内存区域（运行时数据区）"></a>一、Java 内存区域（运行时数据区）</h2><p><strong>JVM1.6&amp;1.7运行时数据区域</strong></p>
<p><strong>Java运行时数据区域JDK1.8</strong></p>
<p><strong>线程私有</strong></p>
<ul>
<li>PC：当前线程所执行的字节码的行号指示器，字节码解释器通过改变 PC 来读取指令。分支、循环、跳转、异常处理、线程恢复都依赖 PC。唯一无 OOM Error</li>
<li>虚拟机栈：描述 Java 方法执行，由栈帧组成（局部变量表、操作数栈、动态链接、方法出口信息等）。存在 StackOverFlowError 和 OOM Error<ul>
<li>局部变量表L存放编译器可知得数据类型（boolean、byte、char、short、int、float、long、double）、对象引用</li>
</ul>
</li>
<li>本地方法栈：运行 native 方法</li>
</ul>
<p><strong>线程共享</strong></p>
<ul>
<li>堆：几乎所有的对象实例和数组都在堆分配</li>
<li>方法区（非堆）：存储已被虚拟机加载的类信息、常量、静态变量、即时编译器编译后的代码数据。</li>
<li>直接内存（非运行时数据区部分）</li>
</ul>
<p><strong>JVM堆内存结构-JDK7</strong></p>
<p><strong>JVM堆内存结构-JDK8</strong></p>
<p><strong>运行时常量池</strong></p>
<blockquote>
<p>编译器生成的各种字面量和符号引号</p>
</blockquote>
<p><strong>直接内存</strong></p>
<blockquote>
<p>不属于JVM运行时数据区的部分，也会被频繁地使用 ，也存在 OOM</p>
</blockquote>
<h2 id="二、HotSpot-对象"><a href="#二、HotSpot-对象" class="headerlink" title="二、HotSpot 对象"></a>二、HotSpot 对象</h2><blockquote>
<p>Java 堆中对象分配、布局和访问</p>
</blockquote>
<h3 id="2-1-Java创建对象的过程"><a href="#2-1-Java创建对象的过程" class="headerlink" title="2.1 Java创建对象的过程"></a>2.1 Java创建对象的过程</h3><ul>
<li>类检查检查：JVM 遇到 new 指令时，先检查常量池中是否能定位到这个类的符号引用，并检查这个类是否已被加载、解析和初始化过</li>
<li>分配内存：为新生对象分配内存。分配方式：“指针碰撞” 和 “空闲列表”两种。选择哪种分配方式取决于 Java 堆是否规整，而 Java 堆是否规整又由垃圾收集器是否带有压缩整理的功能<ul>
<li>内存分配并发问题：<ul>
<li>CAS+失败重试：CAS 是乐观锁的一种实现方式。保证更新操作的原子性</li>
<li>TLAB：为每个线程在 Eden 区预留一块内存，首先在 TLAB 分配，当对象大于 TLAB 中剩余内存或 TLAB 内存用尽时，再使用上面 CAS 进行内存分配</li>
</ul>
</li>
</ul>
</li>
<li>初始化零值：将分配到的内存空间都初始化为零值，保证对象的实例字段能被直接使用</li>
<li>设置对象头：对对象进行必要设置，如对象所属类、类的元数据信息地址、对象的哈希吗、对象的 GC 分代年龄等</li>
<li>执行 init 方法：初始化对象数据</li>
</ul>
<h3 id="2-2-对象的内存布局"><a href="#2-2-对象的内存布局" class="headerlink" title="2.2 对象的内存布局"></a>2.2 对象的内存布局</h3><blockquote>
<p>对象在内存中的布局：对象头、实例数据、对齐填充</p>
</blockquote>
<ul>
<li>对象头：对象运行时数据（哈希吗，GC 分代年龄，锁状态标志） + 类型指针（类元数据）</li>
<li>实例数据：对象真实数据</li>
<li>对齐填充：占位，HotSpot 虚拟机的自动内存管理系统要求对象起始地址必须是 8 字节的整数倍</li>
</ul>
<h3 id="2-3-对象的访问定位"><a href="#2-3-对象的访问定位" class="headerlink" title="2.3 对象的访问定位"></a>2.3 对象的访问定位</h3><blockquote>
<p>调用对象数据，访问方式由虚拟机实现而定：1 使用句柄，2 直接指针</p>
</blockquote>
<ul>
<li>句柄：Java 堆中划分出一块内存“句柄池”，栈桢中的引用存储的就是对象的句柄地址，而句柄中包括了对象实例数据与是类型数据各自的具体地址信息</li>
</ul>
<p><strong>优点</strong><br>句柄地址稳定，对西那个被移动时只会改变句柄中的实例数据指针</p>
<p><strong>对象的访问定位-使用句柄</strong></p>
<ul>
<li>直接指针：reference 存储对象的地址</li>
</ul>
<p><strong>优点</strong><br>速度快</p>
<p><strong>对象的访问定位-直接指针</strong></p>
<h2 id="三、String-类和常量池"><a href="#三、String-类和常量池" class="headerlink" title="三、String 类和常量池"></a>三、String 类和常量池</h2><h3 id="3-1-String-对象两种创建方式"><a href="#3-1-String-对象两种创建方式" class="headerlink" title="3.1 String 对象两种创建方式"></a>3.1 String 对象两种创建方式</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">String str1 = <span class="string">&quot;abcd&quot;</span>;<span class="comment">//先检查字符串常量池中有没有&quot;abcd&quot;，如果字符串常量池中没有，则创建一个，然后 str1 指向字符串常量池中的对象，如果有，则直接将 str1 指向&quot;abcd&quot;&quot;；</span></span><br><span class="line">String str2 = <span class="keyword">new</span> String(<span class="string">&quot;abcd&quot;</span>);<span class="comment">//堆中创建一个新的对象</span></span><br><span class="line">String str3 = <span class="keyword">new</span> String(<span class="string">&quot;abcd&quot;</span>);<span class="comment">//堆中创建一个新的对象</span></span><br><span class="line">System.out.println(str1==str2);<span class="comment">//false</span></span><br><span class="line">System.out.println(str2==str3);<span class="comment">//false</span></span><br></pre></td></tr></table></figure>
<p><strong>string对象</strong></p>
<p>Q：String str = new String(“abc”) 创建对象个数<br>A：1 或 2，如果常量池中有字符串常量“abc”，则只在堆中创建一个对象，反之则创建两个，先在常量池中创建，再在堆上创建</p>
<h3 id="3-2-基本类型、包装类型、常量池"><a href="#3-2-基本类型、包装类型、常量池" class="headerlink" title="3.2 基本类型、包装类型、常量池"></a>3.2 基本类型、包装类型、常量池</h3><blockquote>
<p>Byte,Short,Integer,Long,Character,Boolean</p>
</blockquote>
<p>**性能与资源之间的权衡</p>
<ul>
<li>Byte,Short,Integer,Long 默认创建了数据[-128,127] 的相关类型的缓存数据</li>
<li>Character 创建了数值在 [0.127] 范围的缓存数据，Boolean 直接返回创建好的 True or False</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Integer i1 = <span class="number">40</span>; <span class="comment">// Integer i1 = Integer.valueOf(40);</span></span><br><span class="line">Integer i2 = <span class="keyword">new</span> Integer(<span class="number">40</span>);  <span class="comment">// 新对象</span></span><br></pre></td></tr></table></figure>

<h2 id="四、垃圾回收"><a href="#四、垃圾回收" class="headerlink" title="四、垃圾回收"></a>四、垃圾回收</h2><blockquote>
<p>Java 自动内存管理主要针对：对象内存的回收和分配</p>
</blockquote>
<p><code>Java 堆是垃圾收集器管理的主要区域，又名 GC 堆。由于现代收集器基本采用分代垃圾收集算法，进一步划分的目的是更好地回收内存和更快的分配内存</code></p>
<ul>
<li>Java 堆<ul>
<li>新生代<ul>
<li>Eden 区:大部分对象分配区域，在新生代垃圾回收后，如果对象还存活，则进入 s0 或 s1，对象年龄+1</li>
<li>From Survivor 区：from &amp; to 在 GC 后交换角色</li>
<li>To Survivor 区：每次都是空的</li>
</ul>
</li>
<li>老年代：对象年龄到 JVM 规定的值后晋升到老年代，通过 -XX:MaxTenuringThreshold 设置，这个值在 JVM 运行过程中会动态调整</li>
</ul>
</li>
</ul>
<h3 id="4-1-堆空间基本结构"><a href="#4-1-堆空间基本结构" class="headerlink" title="4.1 堆空间基本结构"></a>4.1 堆空间基本结构</h3><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">-verbose</span>:<span class="string">gc</span></span><br><span class="line"><span class="attr">-Xmx200M</span></span><br><span class="line"><span class="attr">-Xms200M</span></span><br><span class="line"><span class="attr">-Xmn50M</span></span><br><span class="line"><span class="meta">-XX</span>:<span class="string">+PrintGCDetails</span></span><br><span class="line"><span class="meta">-XX</span>:<span class="string">TargetSurvivorRatio=60</span></span><br><span class="line"><span class="meta">-XX</span>:<span class="string">+PrintTenuringDistribution</span></span><br><span class="line"><span class="meta">-XX</span>:<span class="string">+PrintGCDetails</span></span><br><span class="line"><span class="meta">-XX</span>:<span class="string">+PrintGCDateStamps</span></span><br><span class="line"><span class="meta">-XX</span>:<span class="string">MaxTenuringThreshold=3</span></span><br><span class="line"><span class="meta">-XX</span>:<span class="string">+UseConcMarkSweepGC</span></span><br><span class="line"><span class="meta">-XX</span>:<span class="string">+UseParNewGC</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="4-2-堆内存分配策略"><a href="#4-2-堆内存分配策略" class="headerlink" title="4.2 堆内存分配策略"></a>4.2 堆内存分配策略</h3><ul>
<li>对象优先分配在 Eden 区</li>
<li>大对象直接进入老年代：避免<code>担保机制</code>带来的复制而降低效率（确保 Minor GC 前，老年代剩余空间本身能容纳新生代所有对象）</li>
<li>长期存活的对象将进入老年代：年龄到一定程度晋升到老年代（默认15岁）</li>
</ul>
<p>HotSopt JM 两类 GC<br><code>部分收集（Partial GC）</code></p>
<ul>
<li>新生代手机（Minor GC/Young GC）：只对新生代进行垃圾收集</li>
<li>老年代收集（Majoy GC/Old GC）：只对老年代</li>
<li>混合收集（Mixed GC）：对新生代和老年代收集<br><code>整堆手机（Full GC）</code>：收集整个 Java 堆和方法区</li>
</ul>
<h3 id="4-3-对象死亡"><a href="#4-3-对象死亡" class="headerlink" title="4.3 对象死亡"></a>4.3 对象死亡</h3><ul>
<li>引用计数器法：简单、效率高，主流虚拟机中没有被使用。无法解决循环引用问题</li>
<li>可达性分析算法：通过一些列“GC r、Roots”作为起点，从这些起点向下搜索，当一个对象到 GC Roots 没有任何引用链，则对象不可用</li>
</ul>
<p><code>可作为 GC Roots 的对象包括以下：</code></p>
<ol>
<li>虚拟机栈（栈帧中的本地变量表）中引用的对象（方法中变量）<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// a 是栈帧中的本地变量，a 就是 GC Root，由于 a = null，a 与 new Rumenz() 对象断开链接，所以对象会被回收</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Rumenz</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span>  <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">         Rumenz a = <span class="keyword">new</span> Rumenz();</span><br><span class="line">         a = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>本地方法栈（Native 方法）中引用的对象</li>
<li>方法区中类静态属性引用的对象（类 static 属性）<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 栈帧中的本地变量a=null,由于a断开了与GC Root对象(a对象)的联系,所以a对象会被回收。由于给Rumenz的成员变量r赋值了变量的引用,并且r成员变量是静态的,所</span></span><br><span class="line"><span class="comment">// 以r就是一个GC Root对象,所以r指向的对象不会被回收</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Rumenz</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Rumenz r;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">       Rumenz a=<span class="keyword">new</span> Rumenz();</span><br><span class="line">       a.r=<span class="keyword">new</span> Rumenz();</span><br><span class="line">       a=<span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>方法区中常量引用的对象（类 final 属性）<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 常量r引用的对象不会因为a引用的对象的回收而被回收</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Rumenz</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Rumenz r=<span class="keyword">new</span> Rumenz();</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">       Rumenz a=<span class="keyword">new</span> Rumenz();</span><br><span class="line">       a=<span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>所有被同步锁持有的对象（synchronized 对象）</li>
</ol>
<h2 id="五、引用"><a href="#五、引用" class="headerlink" title="五、引用"></a>五、引用</h2><ol>
<li>强引用：必不可少，即使 OOM 也不会被回收</li>
<li>软引用：可有可无，内存空间不足才会被回收。可用做实现内存敏感的高速缓存</li>
<li>弱引用：可有可无，生命周期更短，垃圾回收器线程扫描内存区域，进行下一次 GC 时就会被回收，但垃圾回收器线程优先级很低，不一定很快发现弱引用对象</li>
<li>虚引用：任何时候都可能被回收，用来跟踪对象被回收的活动</li>
</ol>
<ul>
<li>不可达对象并非“非死不可”：需要经过二次标记，可达性分析会产生一次标记，然后判断此对象是否有必要执行 finalize 方法，当对象没有覆盖 finalize 方法或者 finalize 方法已经被虚拟机调用过时则为没必要执行。若对象在第二次标记前与其他对象产生引用链，则不会被回收</li>
<li>废弃常量判断：无 String 对象引用的字符串常量</li>
<li>无用的类<ul>
<li>所有实例被回收</li>
<li>加载该类的 ClassLoader 已经被回收</li>
<li>该类的 Class 对象无引用，无法通过反射访问该类的方法</li>
</ul>
</li>
</ul>
<h2 id="六、垃圾收集算法"><a href="#六、垃圾收集算法" class="headerlink" title="六、垃圾收集算法"></a>六、垃圾收集算法</h2><h3 id="6-1-标记-清除算法"><a href="#6-1-标记-清除算法" class="headerlink" title="6.1 标记-清除算法"></a>6.1 标记-清除算法</h3><p><strong>步骤</strong></p>
<ol>
<li>标记：标记所有不需要回收的对象</li>
<li>清除：清理未标记对象</li>
</ol>
<p><strong>存在问题</strong></p>
<ol>
<li>效率问题</li>
<li>空间问题（大量碎片）</li>
</ol>
<h3 id="6-2-标记-复制算法"><a href="#6-2-标记-复制算法" class="headerlink" title="6.2 标记-复制算法"></a>6.2 标记-复制算法</h3><blockquote>
<p>将内存大小分为大小相同的两块，每次使用其中一块，每次一块内存使用完后将存活的对象复制到另一块中，然后把之前一块一次性清理</p>
</blockquote>
<h3 id="6-3-标记-整理算法"><a href="#6-3-标记-整理算法" class="headerlink" title="6.3 标记-整理算法"></a>6.3 标记-整理算法</h3><ul>
<li>标记</li>
<li>移动（向一端移动）</li>
<li>清除（边界线以外的内存）</li>
</ul>
<h3 id="6-4-分代收集算法"><a href="#6-4-分代收集算法" class="headerlink" title="6.4 分代收集算法"></a>6.4 分代收集算法</h3><blockquote>
<p>根据对象存活周期的不同将内存分为几块，根据各年代的特点选择合适的垃圾收集算法</p>
</blockquote>
<h2 id="七、垃圾收集器"><a href="#七、垃圾收集器" class="headerlink" title="七、垃圾收集器"></a>七、垃圾收集器</h2><blockquote>
<p>垃圾回收算法是内存回收的方法论，垃圾收集器就是内存回收的具体实现</p>
</blockquote>
<h3 id="7-1-Serial-收集器"><a href="#7-1-Serial-收集器" class="headerlink" title="7.1 Serial 收集器"></a>7.1 Serial 收集器</h3><blockquote>
<p>单线程收集，工作时必须暂停其他所有的工作线程，直到收集结束。无线程切换的开销</p>
</blockquote>
<ul>
<li>新生代：标记-复制算法</li>
<li>老年代：标记-整理算法</li>
</ul>
<h3 id="7-2-ParNew-收集器"><a href="#7-2-ParNew-收集器" class="headerlink" title="7.2 ParNew 收集器"></a>7.2 ParNew 收集器</h3><blockquote>
<p>Serial 收集器多线程版本，除了使用多线程进行垃圾收集外，其他行为和 Serial 完全一样</p>
</blockquote>
<ul>
<li>新生代：标记-复制算法</li>
<li>老年代：标记-整理算法</li>
</ul>
<h3 id="7-3-Parallel-Scavenge-收集器（JDK8-默认收集器：Parallel-Scavenge-Parallel-Old）"><a href="#7-3-Parallel-Scavenge-收集器（JDK8-默认收集器：Parallel-Scavenge-Parallel-Old）" class="headerlink" title="7.3 Parallel Scavenge 收集器（JDK8 默认收集器：Parallel Scavenge + Parallel Old）"></a>7.3 Parallel Scavenge 收集器（JDK8 默认收集器：Parallel Scavenge + Parallel Old）</h3><blockquote>
<p>和 ParNew 几乎一样，关注点是吞吐量（高效的利用 CPU）</p>
</blockquote>
<h3 id="7-4-Serial-Old-收集器"><a href="#7-4-Serial-Old-收集器" class="headerlink" title="7.4 Serial Old 收集器"></a>7.4 Serial Old 收集器</h3><blockquote>
<p>Serial 收集器的老年代版本</p>
</blockquote>
<h3 id="7-5-Parallel-Old-收集器"><a href="#7-5-Parallel-Old-收集器" class="headerlink" title="7.5 Parallel Old 收集器"></a>7.5 Parallel Old 收集器</h3><blockquote>
<p>Parallel Scavenge 收集器的到年代版本</p>
</blockquote>
<h3 id="7-6-CMS-收集器（Concurrent-Mark-Sweep）"><a href="#7-6-CMS-收集器（Concurrent-Mark-Sweep）" class="headerlink" title="7.6 CMS 收集器（Concurrent Mark Sweep）"></a>7.6 CMS 收集器（Concurrent Mark Sweep）</h3><blockquote>
<p>以获取最短回收停顿时间为目的的收集器，注重用户体验。HotSpot 虚拟机第一款真正意义上的并发收集器</p>
</blockquote>
<p><strong>清除步骤</strong></p>
<ol>
<li>初始标记：暂停所有的其他线程，记录直接与 GC Roots 相连的对象，这一步很快</li>
<li>并发标记：同时开启 GC 和用户线程，记录可达对象（不保证实时性，因为用户线程会更新引用域）</li>
<li>重新标记：修正并发标记期间因为用户线程持续运行而导致标记误差的部分对象记录</li>
<li>并发标记：开启用户线程，GC 线程开始对未标记区域清理</li>
</ol>
<p><strong>优点：</strong> 并发收集、低停顿<br><strong>缺点：</strong> </p>
<ul>
<li>对 CPU 资源敏感</li>
<li>无法处理浮动垃圾</li>
<li>产生空间碎片</li>
</ul>
<h3 id="7-7-G1-收集器"><a href="#7-7-G1-收集器" class="headerlink" title="7.7 G1 收集器"></a>7.7 G1 收集器</h3><blockquote>
<p>面向服务器的垃圾收集器，针对配备多颗处理器及大容量内存的机器，同时满足 GC 停顿时间要求和高吞吐量性能</p>
</blockquote>
<p><strong>特点</strong></p>
<ol>
<li>并行与并发：G1 充分利用 CPU、多核环境下的硬件优势</li>
<li>分代收集：</li>
<li>空间整合：</li>
<li>可预测的停顿：G1 追求低停顿同时还能预测停顿时间</li>
</ol>
<p><strong>步骤</strong></p>
<ul>
<li>初始标记</li>
<li>并发标记</li>
<li>最终标记</li>
<li>筛选回收</li>
</ul>
<p><code>G1 收集器在后台维护了一个优先列表，每次根据允许的收集时间，优先选择回收价值最大的 Region</code></p>
<h3 id="ZGC-收集器"><a href="#ZGC-收集器" class="headerlink" title="ZGC 收集器"></a>ZGC 收集器</h3>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/10/29/java/jvm/" data-id="ckvcgyemd000nrsuobbne739d" data-title="" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-java/juc" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/10/29/java/juc/" class="article-date">
  <time class="dt-published" datetime="2021-10-29T14:26:47.487Z" itemprop="datePublished">2021-10-29</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="juc"><a href="#juc" class="headerlink" title="juc"></a>juc</h1><figure class="highlight md"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">author: WuDG</span><br><span class="line">datetime： 16:0907 星期一 2021年8月2日</span><br><span class="line">position： 杭州乐佳大厦/博彦</span><br></pre></td></tr></table></figure>
<blockquote>
<p>我曾七次鄙视自己的灵魂<br>第一次，当它本可进取时，却故作谦卑；<br>第二次，当它在空虚时，用爱欲来填充；<br>第三次，在困难和容易之间，它选择了容易；<br>第四次，它犯了错，却借由别人也会犯错来宽慰自己；<br>第五次，它自由软弱，却把它认为是生命的坚韧；<br>第六次，当它鄙夷一张丑恶的嘴脸时，却不知那正是自己面具中的一副；<br>第七次，它侧身于生活的污泥中，虽不甘心，却又畏首畏尾。 </p>
</blockquote>
<h2 id="一、多线程入门"><a href="#一、多线程入门" class="headerlink" title="一、多线程入门"></a>一、多线程入门</h2><h3 id="线程安全问题"><a href="#线程安全问题" class="headerlink" title="线程安全问题"></a>线程安全问题</h3><blockquote>
<p>单线程环境正常运行的代码，在多线程环境中可能出现意料之外的结果</p>
</blockquote>
<p><strong>1.1 原子性</strong><br>问题场景：银行转账，账户 A 向账户 B 转 1000元，，其中包含两个操作：账户 A 减去 1000元，B 账户增加 1000元。前面两个操作都成功才是转账成功<br>由于这两个操作不具备原子性，因此可能出现账户 A 扣款成功但账户 B 入款失败的情况</p>
<blockquote>
<p>原子性：多个操作，要么全部执行要不都不执行<br>原子操作：不会被线程调度机制打断的操作，没有上下文切换</p>
</blockquote>
<pre><code class="java">i = 0;  // 只有这个操作是原子操作
i++;
i = j;
i = i + 1;
</code></pre>
<p><code>在 Java 中可以通过使用 synchoniezed 或者 lock 来保证原子性</code></p>
<p><strong>1.2 可见性</strong></p>
<blockquote>
<p>指当多个线程访问同一个变量时，一个线程修改了这个变量的值，其他线程能够立即得到修改后的值<br>工作内存和主内存见数据交互</p>
</blockquote>
<p>Java 提供了 volatile 关键词来解决多线程可见性问题<br>也可通过 synchronized 和 lock 来保证可见性，加锁可以保证同一时刻只有一个线程在执行同步代码块，释放锁之前会将变量刷回至主存</p>
<p><strong>1.3 活跃性问题</strong></p>
<blockquote>
<p>活跃性是指某件正确的事情最终会发生，当某个操作无法继续下去的时候，就会发生活跃性问题<br>活跃性问题一般包括：死锁、活锁、饥饿问题<br>加锁使用不当也容易引入其他问题，如“死锁”</p>
</blockquote>
<ul>
<li>死锁：资源等待且成环，持有资源</li>
<li>活锁：死锁的对立面，都释放资源</li>
<li>饥饿：一个线程无其他异常却迟迟不能继续允许（哲学家用餐问题）<ul>
<li>高优先级的线程一直在运行消耗 CPU，所有的低优先级的线程一直在等待</li>
<li>一些线程被永久堵塞在一个等待进入同步块的状态，而其他线程总是能在它之前持续的对该同步块进行访问</li>
</ul>
</li>
</ul>
<p><strong>1.4 性能问题</strong><br>多线程额外耗时：创建线程、线程上下文切换<br>减少线程上下文切换方法：无锁并发编程、CAS 算法、使用协程</p>
<h2 id="二、内存模型（JMM）"><a href="#二、内存模型（JMM）" class="headerlink" title="二、内存模型（JMM）"></a>二、内存模型（JMM）</h2><blockquote>
<p>由于主存与 CPU 处理器的运算能力之间差距较大，所以传统计算机内存架构中会引入高速缓存来作为主存和CPU之间的缓冲，CPU将常用的数据存放在高速缓存中，运算结束后 CPU 再将运算结果同步到主存中</p>
</blockquote>
<h3 id="2-1-内存架构"><a href="#2-1-内存架构" class="headerlink" title="2.1 内存架构"></a>2.1 内存架构</h3><ul>
<li>CPU</li>
<li>主存</li>
<li>CPU 缓存</li>
<li>CPU 寄存器</li>
</ul>
<h3 id="2-2-缓存一致性问题"><a href="#2-2-缓存一致性问题" class="headerlink" title="2.2 缓存一致性问题"></a>2.2 缓存一致性问题</h3><blockquote>
<p>使用高速缓存解决了 CPU 和主存速率不匹配问题后又引入了一个新的问题：缓存一致性问题</p>
</blockquote>
<p>每个 CPU 内核都有自己的高速缓存，它们共享主内存。当多个 CPU 的运算任务都涉及同一块主内存区域时，CPU 会将数据读取到缓存中进行运算，可能导致各自的缓存数据不一致</p>
<h3 id="2-3-处理器优化和指令重排序"><a href="#2-3-处理器优化和指令重排序" class="headerlink" title="2.3 处理器优化和指令重排序"></a>2.3 处理器优化和指令重排序</h3><blockquote>
<p>为了使处理器内部的运算单元最大化被充分利用，处理器会对输入代码进行重排序执行<br>提升 CPU 执行效率：处理器优化<br>除了处理器会对代码进行优化处理，还有部分编译器也会做类似优化，如 Java 的即时编译器（JIT）会做指令重排序</p>
</blockquote>
<p>重排序类型：</p>
<ul>
<li>编译器优化的重排序：在不改变单线程语义前提下，可以重新安排语句的执行顺序</li>
<li>指令级并行的重排序：现代处理器采用了指令级并行技术来将多条指令重叠执行。如果不存在数据依赖性，处理器可以改变语句对应机器指令的执行顺序</li>
<li>内存系统的重排序：由于处理器使用缓存和读写缓冲区，使得加载和存储看起来乱序执行</li>
</ul>
<p>定义一套内存模型，规范内存的读写操作。内存模型解决并发问题两种方式：限制处理器优化和使用内存屏障</p>
<ul>
<li>所有变量都存储在主内存中</li>
<li>每个线程都有一个私有的本地内存，本地内存中存储了该现场以读/写共享变量的拷贝副本</li>
<li>线程对变量的所有操作都必须在本地内存进行，不能直接读写主内存</li>
<li>不同的线程之间无法直接访问对方本地内存中的变量</li>
</ul>
<p>为了更好的控制主内存和本地内存的交互，Java 内存模型定义了八种操作：</p>
<ol>
<li>lock：锁定，作用于主内存的变量，把一个变量标识为一条线程独占状态</li>
<li>unlock：读取，作用于主内存变量，把一个处于锁定状态的变量释放出来，释放后的变量才可以被其线程锁定</li>
<li>read：读取。作用于主内存变量，把一个变量值从主内存传输到线程的工作内存中，以便随后的load动作使用</li>
<li>load：载入。作用于工作内存的变量，它把read操作从主内存中得到的变量值放入工作内存的变量副本中。</li>
<li>use：使用。作用于工作内存的变量，把工作内存中的一个变量值传递给执行引擎，每当虚拟机遇到一个需要使用变量的值的字节码指令时将会执行这个操作。</li>
<li>assign：赋值。作用于工作内存的变量，它把一个从执行引擎接收到的值赋值给工作内存的变量，每当虚拟机遇到一个给变量赋值的字节码指令时执行这个操作。</li>
<li>store：存储。作用于工作内存的变量，把工作内存中的一个变量的值传送到主内存中，以便随后的write的操作。</li>
<li>write：写入。作用于主内存的变量，它把store操作从工作内存中一个变量的值传送到主内存的变量中。</li>
</ol>
<h3 id="2-4、并发编程的问题"><a href="#2-4、并发编程的问题" class="headerlink" title="2.4、并发编程的问题"></a>2.4、并发编程的问题</h3><ul>
<li>缓存一致性问题 – 可见性问题</li>
<li>处理器优化 – 原子性问题</li>
<li>指令重排序 – 有序性问题  </li>
</ul>
<h2 id="三、CAS-原理"><a href="#三、CAS-原理" class="headerlink" title="三、CAS 原理"></a>三、CAS 原理</h2><p>i++ 操作是非线程安全的，因为 i++ 不是原子操作<br>保证原子性：加锁（synchronized 和 CAS）</p>
<ul>
<li>synchronized：悲观锁，线程执行需要先获取锁，结束后再释放锁</li>
<li>CAS：乐观锁，失败重试</li>
</ul>
<h3 id="3-1-CAS-概述"><a href="#3-1-CAS-概述" class="headerlink" title="3.1 CAS 概述"></a>3.1 CAS 概述</h3><blockquote>
<p>Compare-And-Swap：比较并交换，是一条 CPU 并发原语，用于判断内存中某个值是否为预期值，如果是则改为新的值，这个过程是原子的</p>
</blockquote>
<p>CAS 机制中三个基本操作数：内存地址 V，旧的预期值 A，计算后要修改后的值 B</p>
<p>总结：更新一个变量的时候，只有当变量的预期值 A 和内存地址 V 中的实际值相同时，才会将内存地址 V 对应的值修改为 B，这整个操作就是CAS</p>
<h3 id="3-2-CAS-原理"><a href="#3-2-CAS-原理" class="headerlink" title="3.2 CAS 原理"></a>3.2 CAS 原理</h3><p>CAS 主要包括两个操作：Compare 和 Swap<br>CAS 是一种系统原语，原语由若干指令组成，用于完成某个功能，且原语的执行必须是连续的，由系统硬件保证</p>
<h3 id="3-3-CAS-在-Java-中的应用"><a href="#3-3-CAS-在-Java-中的应用" class="headerlink" title="3.3 CAS 在 Java 中的应用"></a>3.3 CAS 在 Java 中的应用</h3><p>Java 中通常不会直接使用 CAS，都是通过 JDK 封装好的兵法工具类间接使用，在 <code>java.util.concurrent</code> 包中</p>
<p>CAS 主要在 JUC 下面的 atomic 包下<br>如 AtomicInteger 类就可以解决 i++ 非原子性问题，主要通过 Unsafe 下面的方法 和 volatile 关键词实现原子操作</p>
<h3 id="3-4-CAS-存在的问题"><a href="#3-4-CAS-存在的问题" class="headerlink" title="3.4 CAS 存在的问题"></a>3.4 CAS 存在的问题</h3><ul>
<li><strong>ABA问题</strong>：A -&gt; B -&gt; A，增加版本号，每次更新变量就把版本号 +1</li>
<li><strong>自旋开销</strong>：限制自旋次数，避免过度消耗 CPU</li>
<li><strong>只能保证单个变量的原子性</strong>：如果有多个，则只能通过 synchronized 或 lock</li>
</ul>
<h2 id="四、Java-中的锁"><a href="#四、Java-中的锁" class="headerlink" title="四、Java 中的锁"></a>四、Java 中的锁</h2><h3 id="4-1-乐观锁-amp-悲观锁"><a href="#4-1-乐观锁-amp-悲观锁" class="headerlink" title="4.1 乐观锁&amp;悲观锁"></a>4.1 乐观锁&amp;悲观锁</h3><ul>
<li>悲观锁：synchronized 和 ReentrantLock，适合写多读少场景</li>
<li>乐观锁：使用 <code>CAS 算法</code>和<code>版本号机制</code>实现，适合读多写少场景</li>
</ul>
<h3 id="4-2-独占锁-amp-共享锁"><a href="#4-2-独占锁-amp-共享锁" class="headerlink" title="4.2 独占锁&amp;共享锁"></a>4.2 独占锁&amp;共享锁</h3><ul>
<li>独占锁：只能被一个线程持有（Lock）</li>
<li>共享锁：可被多个线程持有，获取共享锁的线程只能读数据，不能修改数据（ReentrantReadWriteLock）</li>
</ul>
<h3 id="4-3-互斥锁-amp-读写锁"><a href="#4-3-互斥锁-amp-读写锁" class="headerlink" title="4.3 互斥锁&amp;读写锁"></a>4.3 互斥锁&amp;读写锁</h3><ul>
<li>互斥锁：类似独占锁和悲观锁</li>
<li>读写锁：共享锁的一种具体实现，一个只读的锁和一个写锁，只能一个写线程，可以多个读线程（ReadWriteLock）</li>
</ul>
<h3 id="4-4-公平锁-amp-非公平锁"><a href="#4-4-公平锁-amp-非公平锁" class="headerlink" title="4.4 公平锁&amp;非公平锁"></a>4.4 公平锁&amp;非公平锁</h3><ul>
<li>公平锁：指多个线程按照申请锁的顺序来获取锁，类似队列（new ReentrantLock(true);）</li>
<li>非公平锁：并不是按照申请锁的顺序，按照现场优先级（new ReentrantLock();）</li>
</ul>
<h3 id="4-5-可重入锁（递归锁）"><a href="#4-5-可重入锁（递归锁）" class="headerlink" title="4.5 可重入锁（递归锁）"></a>4.5 可重入锁（递归锁）</h3><ul>
<li>指同一个线程在外层方法获取了锁，在进入内层方法会自动获取锁（ReentrantLock，synchronized）</li>
</ul>
<h3 id="4-6-自旋锁"><a href="#4-6-自旋锁" class="headerlink" title="4.6 自旋锁"></a>4.6 自旋锁</h3><ul>
<li>指线程在没有获得锁时不是被直接挂起，而是执行一个忙循环，即自旋（CAS）</li>
</ul>
<h3 id="4-7-分段锁"><a href="#4-7-分段锁" class="headerlink" title="4.7 分段锁"></a>4.7 分段锁</h3><ul>
<li>将锁的粒度进一步细化，当操作不需要更新整个数组的时候，就仅仅针对数组中的一项进行枷锁操作（CurrentHashMap）</li>
</ul>
<h3 id="4-8-锁升级"><a href="#4-8-锁升级" class="headerlink" title="4.8 锁升级"></a>4.8 锁升级</h3><blockquote>
<p>减少获得锁和释放锁带来的消耗<br>无锁 -&gt; 偏向锁 -&gt; 轻量级锁 -&gt; 重量级锁 </p>
</blockquote>
<ul>
<li>无锁：即乐观锁</li>
<li>偏向锁：偏向于第一个访问锁的线程</li>
<li>轻量级锁：线程竞争激烈时，偏向锁升级为轻量级锁，竞争程度很低，通过自旋方式等待上一个线程释放锁</li>
<li>重量级锁：线程竞争加剧，自旋超过一定次数，或者有两个线程，一个线程持有锁，一个在自旋，又来了第三个线程访问时，轻量级锁就会膨胀为重量级锁</li>
</ul>
<h3 id="4-9-锁优化技术（粗化、消除）"><a href="#4-9-锁优化技术（粗化、消除）" class="headerlink" title="4.9 锁优化技术（粗化、消除）"></a>4.9 锁优化技术（粗化、消除）</h3><ul>
<li>粗化：减少同步块的数量，如对 for 循环中的 synchronized 块进行粗化，把 for 循环放在 synchronized 代码块中</li>
<li>细化：线程安全的方法中使用 StringBuffer#append 方法，为了提升销量，虚拟机会消除方法的同步锁</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/10/29/java/juc/" data-id="ckvcgyemc000mrsuo3h0rbjz8" data-title="" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-java/java se" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/10/29/java/java%20se/" class="article-date">
  <time class="dt-published" datetime="2021-10-29T14:26:47.477Z" itemprop="datePublished">2021-10-29</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="Java-SE"><a href="#Java-SE" class="headerlink" title="Java SE"></a>Java SE</h1><figure class="highlight md"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">author: WuDG</span><br><span class="line">datetime： 15:2451 星期一 2021年8月2日</span><br><span class="line">position： 杭州乐佳大厦/博彦</span><br></pre></td></tr></table></figure>
<blockquote>
<p>我曾七次鄙视自己的灵魂<br>第一次，当它本可进取时，却故作谦卑；<br>第二次，当它在空虚时，用爱欲来填充；<br>第三次，在困难和容易之间，它选择了容易；<br>第四次，它犯了错，却借由别人也会犯错来宽慰自己；<br>第五次，它自由软弱，却把它认为是生命的坚韧；<br>第六次，当它鄙夷一张丑恶的嘴脸时，却不知那正是自己面具中的一副；<br>第七次，它侧身于生活的污泥中，虽不甘心，却又畏首畏尾。 </p>
</blockquote>
<h2 id="一、tools"><a href="#一、tools" class="headerlink" title="一、tools"></a>一、tools</h2><p><a target="_blank" rel="noopener" href="https://www.runoob.com/manual/jdk11api/index.html">Java 在线工具</a></p>
<p><a target="_blank" rel="noopener" href="https://www.runoob.com/manual/jdk11api/index.html">JDK 11 在线中文手册</a></p>
<h2 id="2、入门"><a href="#2、入门" class="headerlink" title="2、入门"></a>2、入门</h2><h3 id="2-1-简介"><a href="#2-1-简介" class="headerlink" title="2.1 简介"></a>2.1 简介</h3><ul>
<li>JavaSE/JavaEE/JavaME</li>
<li>语法类似 C 和 C++，丢弃 C++ 中操作符重载、多继承、自动强制类型转换，提供自动分配和回收内存</li>
<li>简单的/面向对象的/分布式的/健壮的/安全的/可移植的/解释型的/多线程的/动态的</li>
</ul>
<h3 id="2-2-开发环境配置"><a href="#2-2-开发环境配置" class="headerlink" title="2.2 开发环境配置"></a>2.2 开发环境配置</h3><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">JAVA_HOME</span>=<span class="string"></span></span><br><span class="line"><span class="attr">CLASSPATH</span>=<span class="string">.;%JAVA_HOME%\lib\dt.jar;%JAVA_HOME%\lib\tools.jar</span></span><br><span class="line"><span class="attr">Path</span>=<span class="string">$Path;%JAVA_HOME%\bin;%JAVA_HOME%\jre\bin;</span></span><br></pre></td></tr></table></figure>

<h3 id="2-3-基础语法"><a href="#2-3-基础语法" class="headerlink" title="2.3 基础语法"></a>2.3 基础语法</h3><ul>
<li>对象/类/方法/实例变量</li>
<li>大小写敏感/类名/方法名/源文件名/主方法入口/标识符/修饰符/变量（局部变量、类变量、成员变量）/数组/枚举</li>
<li>访问修饰符（default、public、protected、private），非访问修饰符（final、abstract、static、synchonized、transient、volatile）</li>
</ul>
<h3 id="2-4-对象和类"><a href="#2-4-对象和类" class="headerlink" title="2.4 对象和类"></a>2.4 对象和类</h3><ul>
<li>多态/继承/封装/抽象/类/对象/实例/方法/重载</li>
</ul>
<h3 id="2-5-基本数据类型"><a href="#2-5-基本数据类型" class="headerlink" title="2.5 基本数据类型"></a>2.5 基本数据类型</h3><h4 id="数据类型"><a href="#数据类型" class="headerlink" title="数据类型"></a>数据类型</h4><ul>
<li>内置数据类型（byte、short、int、long、float、double、bool、char）</li>
<li>引用数据类型（对象、数组）</li>
<li>常量（final）</li>
</ul>
<p><strong>自动类型换转</strong></p>
<blockquote>
<p>低  ————————————————&gt;  高<br>byte,short,char—&gt; int —&gt; long—&gt; float —&gt; double</p>
</blockquote>
<ul>
<li>大类型转小类型需要强制转换</li>
<li>隐式强制类型转换（整形默认 int，小数默认 double）</li>
</ul>
<h3 id="2-6-修饰符"><a href="#2-6-修饰符" class="headerlink" title="2.6 修饰符"></a>2.6 修饰符</h3><ul>
<li>default：默认，当前包可见</li>
<li>private：当前类可见</li>
<li>public：所有类可见</li>
<li>protected：当前包和所有子类可见</li>
</ul>
<h3 id="2-7-switch"><a href="#2-7-switch" class="headerlink" title="2.7 switch"></a>2.7 switch</h3><ul>
<li>支持 char、short、int、byte、String</li>
</ul>
<h3 id="2-8-Java-异常-amp-错误"><a href="#2-8-Java-异常-amp-错误" class="headerlink" title="2.8 Java 异常&amp;错误"></a>2.8 Java 异常&amp;错误</h3><ul>
<li>检查异常：无法预见的问题，如打开文件不存在</li>
<li>运行时异常：可被避免，可在编译时被忽略</li>
<li>错误：脱离程序控制，如 stack overflow、oom等</li>
</ul>
<p><strong>Throwable</strong></p>
<ul>
<li>Error<ul>
<li>OutOfMemoryError</li>
</ul>
</li>
<li>IOError</li>
<li>Exception<ul>
<li>IOException<ul>
<li>FileNotFoundException</li>
</ul>
</li>
<li>RuntimeException<ul>
<li>NullPointerException</li>
</ul>
</li>
</ul>
</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/10/29/java/java%20se/" data-id="ckvcgyemb000lrsuoe5olgv3k" data-title="" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-framework/spring" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/10/29/framework/spring/" class="article-date">
  <time class="dt-published" datetime="2021-10-29T14:26:47.467Z" itemprop="datePublished">2021-10-29</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="Spring"><a href="#Spring" class="headerlink" title="Spring"></a>Spring</h1><blockquote>
<p>为现代基于 Java 的企业应用程序提供一个全面的变成和配置模型</p>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://spring.io/projects/spring-framework">地址</a></p>
<h2 id="一、特征"><a href="#一、特征" class="headerlink" title="一、特征"></a>一、特征</h2><ul>
<li>核心：依赖注入、event、resource、i18n、验证、数据绑定、类型转换、SpEL、AOP</li>
<li>测试：mock 对象、测试框架</li>
<li>数据访问：JDBC</li>
<li>Spring MVC 和 Spring WebFlux web 框架</li>
<li>整合：远程、JMS、JCA、JMX、scheduling、cache</li>
<li>语言：Kotlin、Groovy、动态语言</li>
</ul>
<h2 id="二、核心"><a href="#二、核心" class="headerlink" title="二、核心"></a>二、核心</h2>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/10/29/framework/spring/" data-id="ckvcgyeli000krsuo757g8bdp" data-title="" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-db/redis" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/10/29/db/redis/" class="article-date">
  <time class="dt-published" datetime="2021-10-29T14:26:47.444Z" itemprop="datePublished">2021-10-29</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="redis"><a href="#redis" class="headerlink" title="redis"></a>redis</h1><figure class="highlight md"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">author: WuDG</span><br><span class="line">datetime： 10:4040 星期二 2021年8月3日</span><br><span class="line">position： 杭州乐佳大厦/博彦</span><br></pre></td></tr></table></figure>
<blockquote>
<p>我曾七次鄙视自己的灵魂<br>第一次，当它本可进取时，却故作谦卑；<br>第二次，当它在空虚时，用爱欲来填充；<br>第三次，在困难和容易之间，它选择了容易；<br>第四次，它犯了错，却借由别人也会犯错来宽慰自己；<br>第五次，它自由软弱，却把它认为是生命的坚韧；<br>第六次，当它鄙夷一张丑恶的嘴脸时，却不知那正是自己面具中的一副；<br>第七次，它侧身于生活的污泥中，虽不甘心，却又畏首畏尾。 </p>
</blockquote>
<h2 id="一、redis-概述-amp-redis-特点"><a href="#一、redis-概述-amp-redis-特点" class="headerlink" title="一、redis 概述 &amp; redis 特点"></a>一、redis 概述 &amp; redis 特点</h2><blockquote>
<p>Redis（Remote Dictionary Server）远程数据服务，是一种支持 key-value 等多种数据结构的存储系统。可用于缓存，事件发布或订阅，高速队列等场景。支持网络，提供 string，hash，list，set，zset 等数据结构，基于内存，可持久化</p>
</blockquote>
<ul>
<li>丰富的数据类型：适用场景多</li>
<li>内存存储：快</li>
<li>持久化：数据安全</li>
</ul>
<h2 id="二、数据结构"><a href="#二、数据结构" class="headerlink" title="二、数据结构"></a>二、数据结构</h2><blockquote>
<p>redis 是 key-value 数据库，key 只能是 string，value 可以是 string、hash、list、set、 sorted set</p>
</blockquote>
<ul>
<li>string：最大存储 512m（set key_name value），信息缓存、计数器、分布式锁</li>
<li>hash：适合存储对象，key-value 集合(hset key_name field value)，购物车（用户id为key，商品id为field，商品数量为value）</li>
<li>list：字符串列表，有序可重复（lpush key_name value1.. value10），是一个分页做定时排行榜</li>
<li>set：字符串无序不可重复集合（sadd key_name value…），收藏夹</li>
<li>sorted set：有序集合（zadd key_name score value），实时排行榜</li>
</ul>
<h2 id="三、redis-持久化策略"><a href="#三、redis-持久化策略" class="headerlink" title="三、redis 持久化策略"></a>三、redis 持久化策略</h2><blockquote>
<p>将内存中数据存储到磁盘中</p>
</blockquote>
<ul>
<li>RDB：快照存储</li>
<li>AOF：记录写操作，追加到日志文件中，服务器重启时重新执行这些命令</li>
<li>不使用持久化</li>
<li>RDB&amp;AOF：同时开启两种持久化，redis重启时优先载入 AOP 文件来恢复原始数据，AOF中数据比RDB更加完整</li>
</ul>
<h2 id="四、redis-线程模型"><a href="#四、redis-线程模型" class="headerlink" title="四、redis 线程模型"></a>四、redis 线程模型</h2><p>redis 内部使用文件处理器，单线程架构。采用 IO 多路复用机制同时监听多个 socket，根据 socket 上的事件选择对应的事件处理器进行处理<br>单线程高效率：</p>
<ul>
<li>纯内存操作</li>
<li>核心是基于非阻塞的 IO 多路复用机制</li>
<li>单线程避免了多线程上下文切换</li>
</ul>
<h2 id="五、常见问题"><a href="#五、常见问题" class="headerlink" title="五、常见问题"></a>五、常见问题</h2><ul>
<li>雪崩：缓存中大批量 key 过期，请求直接落到数据库。使 key 过期时间均匀，加互斥锁，用不国旗</li>
<li>穿透：恶意请求系统中不存在的数据。使用布隆过滤器（爬虫系统url去重、垃圾邮件过滤、黑名单），返回空对象</li>
<li>预热：系统上线后将缓存数据直接加载到缓存系统，避免用户请求直接落到数据库再写到缓存。工程启动时进行加载缓存动作，设置一个定时任务脚本，先保证热点数据提前加载到缓存</li>
<li>击穿：某热点 key 失效瞬间，请求直接落到数据库。增加回血缓存互斥锁，热点 key 永不过期</li>
<li>降级：指缓存失效或者服务器挂掉，不直接访问数据库，直接返回默认值或者访问服务的内存数据，避免数据库遭受巨大压力</li>
</ul>
<h2 id="六、内存淘汰机制"><a href="#六、内存淘汰机制" class="headerlink" title="六、内存淘汰机制"></a>六、内存淘汰机制</h2><blockquote>
<p>redis 缓存不足时，通过淘汰旧数据来处理新加入数据的策略</p>
</blockquote>
<ul>
<li>noeviction：默认策略，对于写请求直接返回错误</li>
<li>allkeys-lru：所有 key 最近最少使用</li>
<li>volatile-rlu：设置了过期时间的 key 最近最少使用</li>
<li>allkeys-random：所有 key 中随机淘汰</li>
<li>volatile-random：从设置了过期时间的 key 中随机淘汰</li>
<li>volatile-ttl：在设计了过期时间的 key 中根据过期时间淘汰最早过期的 key</li>
<li>allkeys-lfu：所有的 key 中，最少使用频率，4.0开始支持</li>
<li>volatile-lfu：设置了过期时间的 key 中，最少使用频率，4.0开始支持</li>
</ul>
<h2 id="七、redis事务机制"><a href="#七、redis事务机制" class="headerlink" title="七、redis事务机制"></a>七、redis事务机制</h2><blockquote>
<p>MULTI 开启，操作命令加入队列，EXEC 命令开始顺序执行。如果执行报错，不会回滚</p>
</blockquote>
<ul>
<li>WATCH：为 redis 提供 check-and-set（CAS）行为。被 WATCH 的 key 如果被改动，则 EXEC 时会返回 nil-reply</li>
<li>MULTI：开启一个事务</li>
<li>UNWATCH：取消 WATCH 命令所有的 key</li>
<li>DISCARD：放弃事务，事务列表被清空，并退出事务状态</li>
<li>EXEC：负责执行事务中所有命令</li>
</ul>
<h2 id="八、redis-主从复制"><a href="#八、redis-主从复制" class="headerlink" title="八、redis 主从复制"></a>八、redis 主从复制</h2><blockquote>
<p>指将一台 redis 服务器数据复制到其他 redis 服务器。前者为主节点（master），后者为从节点（slave）。数据的复制是单向的，只能由主到从</p>
</blockquote>
<p>主从复制作用：</p>
<ul>
<li>数据荣誉：热数据备份</li>
<li>故障恢复：主节点故障，可以由从节点提供服务</li>
<li>负载均衡：读写分离，主节点负责写数据，从节点负责读数据</li>
<li>高可用：是哨兵和集群的基础</li>
</ul>
<p>实现原理：</p>
<blockquote>
<p>三个阶段：连接建立阶段、数据同步阶段、命令传播阶段</p>
</blockquote>
<h2 id="九、哨兵（Sentinel）原理"><a href="#九、哨兵（Sentinel）原理" class="headerlink" title="九、哨兵（Sentinel）原理"></a>九、哨兵（Sentinel）原理</h2><blockquote>
<p>是 redis 高可用的实现方案，管理多个 redis 实例，实现对 redis 的监控、通知、自动故障转移</p>
</blockquote>
<p>问题引入：redis 主从负责模式下，一旦主节点故障无法提供服务，需要手动将从节点晋升为主节点，还需要通知客户端更新主节点地址，这个故障处理方案是不可取的</p>
<h2 id="十、-memcache-amp-redis-区别"><a href="#十、-memcache-amp-redis-区别" class="headerlink" title="十、 memcache &amp; redis 区别"></a>十、 memcache &amp; redis 区别</h2><ul>
<li>memcache 纯内存，数据量不能超过内存，redis 支持持久化</li>
<li>memcache 只支持 string，redis 支持多种</li>
</ul>
<h2 id="客户端"><a href="#客户端" class="headerlink" title="客户端"></a>客户端</h2><ul>
<li>Jedis</li>
<li>Redisson</li>
<li>Lettuce</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/10/29/db/redis/" data-id="ckvcgyeks000crsuo0ftr0trb" data-title="" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-core/linux" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/10/29/core/linux/" class="article-date">
  <time class="dt-published" datetime="2021-10-29T14:26:47.420Z" itemprop="datePublished">2021-10-29</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="linux"><a href="#linux" class="headerlink" title="linux"></a>linux</h1><h2 id="awk"><a href="#awk" class="headerlink" title="awk"></a>awk</h2><blockquote>
<p>处理文本文件的语言，是一个强大的文本分析工具</p>
</blockquote>
<h3 id="基本用法"><a href="#基本用法" class="headerlink" title="基本用法"></a>基本用法</h3><h4 id="用法一"><a href="#用法一" class="headerlink" title="用法一"></a>用法一</h4><blockquote>
<p>awk ‘{[pattern] action}’ {filenames}   # 行匹配语句 awk ‘’ 只能用单引号</p>
</blockquote>
<p><strong>示例</strong><br><code>log.txt</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">2 this is a test</span><br><span class="line">3 Are you like awk</span><br><span class="line">This&#x27;s a test</span><br><span class="line">10 There are orange,apple,mongo</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 每行按空格或TAB分割，输出文本中的1、4项</span></span><br><span class="line">awk &#x27;&#123;print $1,$4&#125;&#x27; log.txt</span><br><span class="line"><span class="meta">#</span><span class="bash"> 格式化输出</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> awk <span class="string">&#x27;&#123;printf &quot;%-8s %-10s\n&quot;,$1,$4&#125;&#x27;</span> log.txt</span></span><br></pre></td></tr></table></figure>

<h4 id="用法二"><a href="#用法二" class="headerlink" title="用法二"></a>用法二</h4><blockquote>
<p>awk -F  #-F相当于内置变量FS, 指定分割字符</p>
</blockquote>
<p><strong>示例</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 使用逗号分割</span></span><br><span class="line">awk -F, &#x27;&#123;print $1,$4&#125;&#x27; awk.txt</span><br><span class="line"><span class="meta">#</span><span class="bash"> 或者使用内建变量</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> awk <span class="string">&#x27;BEGIN&#123;FS=&quot;,&quot;&#125; &#123;print $1,$2&#125;&#x27;</span> awk.txt</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用多个分隔符，先使用空格分割，然后对分割结果再使用<span class="string">&quot;,&quot;</span>分割</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> awk -F <span class="string">&#x27;[ ,]&#x27;</span>  <span class="string">&#x27;&#123;print $1,$2,$5&#125;&#x27;</span>   awk.txt</span></span><br></pre></td></tr></table></figure>

<h4 id="用法三"><a href="#用法三" class="headerlink" title="用法三"></a>用法三</h4><blockquote>
<p>awk -v  # 设置变量</p>
</blockquote>
<p><strong>示例</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">awk -v a=1 &#x27;&#123;print $1,$1+a&#125;&#x27; awk.txt</span><br><span class="line"><span class="meta">#</span><span class="bash"> awk -va=1 -vb=s <span class="string">&#x27;&#123;print $1,$1+a,$1b&#125;&#x27;</span> awk.txt</span></span><br></pre></td></tr></table></figure>

<h3 id="用法四"><a href="#用法四" class="headerlink" title="用法四"></a>用法四</h3><blockquote>
<p>awk -f {awk脚本} {文件名}</p>
</blockquote>
<p><strong>示例</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">awk -f cal.awk awk.txt</span><br></pre></td></tr></table></figure>

<h3 id="使用正则，字符串匹配"><a href="#使用正则，字符串匹配" class="headerlink" title="使用正则，字符串匹配"></a>使用正则，字符串匹配</h3><p><strong>示例</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">awk &#x27;$2 ~ /th/ &#123;print $2,$4&#125;&#x27; awk.txt</span><br><span class="line"><span class="meta">#</span><span class="bash"> 输出包含 <span class="string">&quot;re&quot;</span> 的行</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> awk <span class="string">&#x27;/re/ &#x27;</span> awk.txt</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 忽略大小写</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> awk <span class="string">&#x27;BEGIN&#123;IGNORECASE=1&#125; /this/&#x27;</span> awk.txt</span></span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/10/29/core/linux/" data-id="ckvcgyeju0006rsuo6zhk6tbb" data-title="" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-tools/zookeeper" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/10/29/tools/zookeeper/" class="article-date">
  <time class="dt-published" datetime="2021-10-29T14:26:47.407Z" itemprop="datePublished">2021-10-29</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="zookeeper"><a href="#zookeeper" class="headerlink" title="zookeeper"></a>zookeeper</h1><figure class="highlight md"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">author: WuDG</span><br><span class="line">datetime： 11:0932 星期四 2021年8月5日</span><br><span class="line">position： 杭州乐佳大厦/博彦</span><br></pre></td></tr></table></figure>
<blockquote>
<p>我曾七次鄙视自己的灵魂<br>第一次，当它本可进取时，却故作谦卑；<br>第二次，当它在空虚时，用爱欲来填充；<br>第三次，在困难和容易之间，它选择了容易；<br>第四次，它犯了错，却借由别人也会犯错来宽慰自己；<br>第五次，它自由软弱，却把它认为是生命的坚韧；<br>第六次，当它鄙夷一张丑恶的嘴脸时，却不知那正是自己面具中的一副；<br>第七次，它侧身于生活的污泥中，虽不甘心，却又畏首畏尾。 </p>
</blockquote>
<h2 id="一、zookeeper-入门"><a href="#一、zookeeper-入门" class="headerlink" title="一、zookeeper 入门"></a>一、zookeeper 入门</h2><h3 id="1-1-zookeeper-概述"><a href="#1-1-zookeeper-概述" class="headerlink" title="1.1 zookeeper 概述"></a>1.1 zookeeper 概述</h3><blockquote>
<p>zk 是一个开源的分布式协调服务，将复杂且容易出错的分布式一致性服务封装起来，构成一个高效可靠的原语集，提供给用户使用</p>
</blockquote>
<p>zk 提供了高可用、高性能、稳定的分布式数据一致性解决方案。通常被用于实现数据发布/订阅、负载均衡、命名服务、分布式协调/通知、集群管理、master 选举、分布式锁和分布式队列等功能</p>
<p>另外，zk 将数据保存在内存中，性能很nice</p>
<h3 id="1-2-zk-特点"><a href="#1-2-zk-特点" class="headerlink" title="1.2 zk 特点"></a>1.2 zk 特点</h3><ul>
<li>顺序一致性：客户端发起的事务，按照顺序被应用到 zk 中</li>
<li>原子性：事务请求，对集群中所有的及其应用情况是一样的，要么都成功，要么都失败</li>
<li>单一系统映像：zk 集群保证查询到的数据都是一致的</li>
<li>可靠性：一旦更改请求被应用，数据将持久化</li>
</ul>
<h3 id="1-3-应用场景"><a href="#1-3-应用场景" class="headerlink" title="1.3 应用场景"></a>1.3 应用场景</h3><ul>
<li>分布式锁：通过创建唯一节点获得分布式锁，当获得锁的一方执行完或者挂掉后就释放锁</li>
<li>命名服务：通过 zk 的顺序节点生成全局唯一 ID</li>
<li>数据发布/订阅：通过 Watch 机制，实现数据发布/订阅。数据被发布到 zk 的被监听的节点上，其他及其可以通过监听该节点来实现配置的动态更新</li>
</ul>
<blockquote>
<p>开源项目使用 zk：kafka、hbase、hadoop</p>
</blockquote>
<h2 id="二、zk-重点"><a href="#二、zk-重点" class="headerlink" title="二、zk 重点"></a>二、zk 重点</h2><blockquote>
<p>zk 主要是用来协调服务的，不是用来存储业务数据的，不能将大数据放在 zk 中</p>
</blockquote>
<h3 id="2-1-Data-model（数据模型）"><a href="#2-1-Data-model（数据模型）" class="headerlink" title="2.1 Data model（数据模型）"></a>2.1 Data model（数据模型）</h3><blockquote>
<p>类 Linux 系统中文件系统，树形结构</p>
</blockquote>
<h3 id="2-2-znode（数据节点）"><a href="#2-2-znode（数据节点）" class="headerlink" title="2.2 znode（数据节点）"></a>2.2 znode（数据节点）</h3><blockquote>
<p>zk 中最小数据单位</p>
</blockquote>
<ul>
<li>持久节点：持久化，直到被删除</li>
<li>临时节点：生命周期为 和客户端绑定（session），会话消失则节点被删除，临时节点只能做叶子节点，不能创建子节点</li>
<li>持久顺序节点：有序（如 /node1/app000000001）</li>
<li>临时顺序节点：有序</li>
</ul>
<p>znode 数据结构</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;stat&quot;</span> : <span class="string">&quot;状态信息&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;data&quot;</span> : <span class="string">&quot;节点存放的内容&quot;</span>   </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>stat 中数据信息</strong></p>
<p>cZxid:create ZXID，即该数据节点被创建时的事务 id<br>ctime:create time，即该节点的创建时间<br>mZxid:modified ZXID，即该节点最终一次更新时的事务 id<br>mtime:modified time，即该节点最后一次的更新时间<br>pZxid:该节点的子节点列表最后一次修改时的事务 id，只有子节点列表变更才会更新 pZxid，子节点内容变更不会更新<br>cversion:子节点版本号，当前节点的子节点每次变化时值增加 1<br>dataVersion:数据节点内容版本号，节点创建时为 0，每更新一次节点内容(不管内容有无变化)该版本号的值增加 1<br>aclVersion:节点的 ACL 版本号，表示该节点 ACL 信息变更次数<br>ephemeralOwner:创建该临时节点的会话的 sessionId；如果当前节点为持久节点，则 ephemeralOwner=0<br>dataLength:数据节点内容长度<br>numChildren:当前节点的子节点个数</p>
<h3 id="2-3-ACL（权限控制）"><a href="#2-3-ACL（权限控制）" class="headerlink" title="2.3 ACL（权限控制）"></a>2.3 ACL（权限控制）</h3><p>对于 znode 的操作权限</p>
<ul>
<li>CREATE：支持创建子节点</li>
<li>READ：能查询节点数据和列出子节点</li>
<li>WRITE：能设置/更新节点数据</li>
<li>DELETE：能删除子节点</li>
<li>ADMIN：能设置节点 ACL 的权限</li>
</ul>
<p><code>CREATE 和 DELETE 都是对子节点的控制权限</code><br> 对于身份认证，提供以下几种方式：</p>
<ul>
<li>world：默认，any user can use</li>
<li>auth：任何已认证用户</li>
<li>digest： username：password</li>
<li>ip：对指定 IP 限制</li>
</ul>
<h3 id="2-4-Watcher（事件监听器）"><a href="#2-4-Watcher（事件监听器）" class="headerlink" title="2.4 Watcher（事件监听器）"></a>2.4 Watcher（事件监听器）</h3><blockquote>
<p>允许节点注册 Watch，在某些特定事件触发时，zk 服务端会将事件通知到感兴趣的客户端</p>
</blockquote>
<h3 id="2-5-Session（会话）"><a href="#2-5-Session（会话）" class="headerlink" title="2.5 Session（会话）"></a>2.5 Session（会话）</h3><blockquote>
<p>可以看作是 zk 与客户端之间的 TCP 长连接</p>
</blockquote>
<p>Session：sessionTimeout 会话超时时间（范围内，仍属于同一个 session）<br>zk 与客户端创建 session 之前，会为客户端分配一个 sessionID，全局唯一</p>
<h2 id="三、zk-集群"><a href="#三、zk-集群" class="headerlink" title="三、zk 集群"></a>三、zk 集群</h2><blockquote>
<p>为了保证高可用，zk 需集群部署，只要集群中大部分机器可用，则集群可用。集群间通过 ZAB（zk Atomic Broadcase） 保证数据一致性</p>
</blockquote>
<p>典型集群模式：Master/Slave（主从模式）</p>
<h3 id="3-1-zk-集群中角色"><a href="#3-1-zk-集群中角色" class="headerlink" title="3.1 zk 集群中角色"></a>3.1 zk 集群中角色</h3><blockquote>
<p>Leader,Follower,Observer</p>
</blockquote>
<ul>
<li>Leader：提供读写，负责投票的发起和决议，更新系统状态</li>
<li>Follower：提供读，参与选举投票，转发写请求给 Leader</li>
<li>Observer：提供读，不参与 Leader 选举</li>
</ul>
<p><strong>leader写数据</strong></p>
<p><strong>读数据</strong></p>
<p>当 Leader 服务器出现网络中断、崩溃退出与重启等异常情况，就会进入 Leader 选举过程</p>
<ol>
<li>Leader election（选举阶段）：只要一个节点得到超过半数节点的票数，则可成为 Leader</li>
<li>Discovery（发现阶段）：Follower 与准 Leader 通信，同步 Follower 最近接收的事务提议</li>
<li>Synchronization（同步阶段）：利用 Leader 前一阶段获得的最新提议历史，同步集群所有的副本。同步完成准 Leader 成为 Leader</li>
<li>Broadcase（广播阶段）：zk 集群正式对外提供事务服务，Leader 可以进行消息广播。若有新节点加入，需对新节点进行同步</li>
</ol>
<h3 id="3-2-zk-集群中服务状态"><a href="#3-2-zk-集群中服务状态" class="headerlink" title="3.2 zk 集群中服务状态"></a>3.2 zk 集群中服务状态</h3><ul>
<li>LOOKING：寻找 Leader</li>
<li>LEADING：Leader 状态，对应的节点为 Leader</li>
<li>FOLLOWING：Follower 状态，对应节点为 Follower</li>
<li>OBSERVING：Observer 状态，对应节点为 Observer，不参与 Leader 选举</li>
</ul>
<h3 id="3-3-zk-集群数量"><a href="#3-3-zk-集群数量" class="headerlink" title="3.3 zk 集群数量"></a>3.3 zk 集群数量</h3><blockquote>
<p>zk 集群，服务器剩余数量大于宕机数量才能继续提供服务。即 2n 和 2n-1 的容忍度是一样的</p>
</blockquote>
<h3 id="3-4-zk-选举的过半机制防止脑裂"><a href="#3-4-zk-选举的过半机制防止脑裂" class="headerlink" title="3.4 zk 选举的过半机制防止脑裂"></a>3.4 zk 选举的过半机制防止脑裂</h3><blockquote>
<p>为保证 zk 集群可用性，服务器通常部署在不同机房，如果机房间网络线路故障，集群被割裂成几个小集群</p>
</blockquote>
<p>过半机制防止脑裂：服务器少于等于一般不可能产生 Leader</p>
<h2 id="四、ZAB-协议和-Paxos-算法"><a href="#四、ZAB-协议和-Paxos-算法" class="headerlink" title="四、ZAB 协议和 Paxos 算法"></a>四、ZAB 协议和 Paxos 算法</h2><h3 id="4-1-ZAB-协议简介"><a href="#4-1-ZAB-协议简介" class="headerlink" title="4.1 ZAB 协议简介"></a>4.1 ZAB 协议简介</h3><blockquote>
<p>ZAB（zk Atomic Broadcast 原子广播）协议是 zk 专门设计的一种支持崩溃恢复的原子广播协议。zk 中主要依赖 ZAB 协议来实现分布式数据一致性，基于该协议，zk 实现了一种主备模式的系统架构来保持集群中各个副本之间数据一致性</p>
</blockquote>
<p>ZAB 协议两种基本的模式：崩溃恢复和消息广播</p>
<ul>
<li>崩溃恢复：当服务框架在启动过程中，或是当 Leader 服务器出现网络中断、崩溃退出与重启等异常时，ZAB 协议就会进入恢复模式并选举新的 Leader。当选举产生了新的 Leader，切已经有过半的机器与 Leader 完成了状态同步后，ZAB 协议就会退出恢复模式。状态同步即数据同步，用来保证集群中存在过半的及其的数据与 Leader 一致</li>
<li>消息广播：当一台遵守 ZAB 协议的服务器启动后加入到集群中时，如果此时集群中已经存在 Leader 在负责进行消息广播，则新加入的服务器会自觉进入数据恢复模式，找到 Leader，进行数据同步</li>
</ul>
<p><strong>选举算法：FastLeaderElection</strong></p>
<ul>
<li>myid：每个 zk 服务器在数据文件夹下创建名为 myid 的文件，内容全局唯一整数 ID</li>
</ul>
<h2 id="五、常用命令"><a href="#五、常用命令" class="headerlink" title="五、常用命令"></a>五、常用命令</h2><ol>
<li>help</li>
<li>create</li>
<li>set</li>
<li>get</li>
<li>ls</li>
<li>stat</li>
<li>ls2（ls + stat）</li>
<li>delete</li>
</ol>
<h2 id="六、总结"><a href="#六、总结" class="headerlink" title="六、总结"></a>六、总结</h2><ol>
<li>zk 是分布式程序（半数以上节点存活则 zk 能正常提供服务）</li>
<li>zk 数据保存在内存中</li>
<li>zk 是高性能</li>
<li>zk 中持久节点&amp;临时节点</li>
<li>zk 底层提供两个功能：管理（存取）程序数据、为用户提供数据节点的监听</li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/10/29/tools/zookeeper/" data-id="ckvcgyeox000zrsuo4qg79dq4" data-title="" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-tools/git" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/10/29/tools/git/" class="article-date">
  <time class="dt-published" datetime="2021-10-29T14:26:47.388Z" itemprop="datePublished">2021-10-29</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="git"><a href="#git" class="headerlink" title="git"></a>git</h1><blockquote>
<p><a target="_blank" rel="noopener" href="https://learngitbranching.js.org/?locale=zh_CN">https://learngitbranching.js.org/?locale=zh_CN</a></p>
</blockquote>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/10/29/tools/git/" data-id="ckvcgyeo1000vrsuoadxm0siz" data-title="" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-hello-world" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/10/29/hello-world/" class="article-date">
  <time class="dt-published" datetime="2021-10-29T13:24:52.364Z" itemprop="datePublished">2021-10-29</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/10/29/hello-world/">Hello World</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>Welcome to <a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a>! This is your very first post. Check <a target="_blank" rel="noopener" href="https://hexo.io/docs/">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a target="_blank" rel="noopener" href="https://hexo.io/docs/troubleshooting.html">troubleshooting</a> or you can ask me on <a target="_blank" rel="noopener" href="https://github.com/hexojs/hexo/issues">GitHub</a>.</p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">&quot;My New Post&quot;</span></span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/writing.html">Writing</a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/server.html">Server</a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/generating.html">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/one-command-deployment.html">Deployment</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/10/29/hello-world/" data-id="ckvceuzp50000hcuo6p9rfzy5" data-title="Hello World" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-python/flask" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2017/07/10/python/flask/" class="article-date">
  <time class="dt-published" datetime="2017-07-10T08:36:26.000Z" itemprop="datePublished">2017-07-10</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2017/07/10/python/flask/">flask</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="flask"><a href="#flask" class="headerlink" title="flask"></a>flask</h1><blockquote>
<p>Flask 中文文档（2.0.1）<br>Flask 以来 Jinja 模板引擎和 Werkzeug WSGI 套件</p>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://dormousehole.readthedocs.io/en/latest/index.html">原文档地址</a></p>
<h2 id="一、安装"><a href="#一、安装" class="headerlink" title="一、安装"></a>一、安装</h2><h3 id="python-版本"><a href="#python-版本" class="headerlink" title="python 版本"></a>python 版本</h3><blockquote>
<p>Flask 支持 Python 3.6 及更高版本</p>
</blockquote>
<h3 id="依赖"><a href="#依赖" class="headerlink" title="依赖"></a>依赖</h3><blockquote>
<p>当安装 Flask 时，以下套件软件会被自动安装</p>
</blockquote>
<ul>
<li>Werkzeug 用于实现 WSGI，应用和服务之间的标准 Python 接口</li>
<li>Jinja 用于渲染页面的模板语言</li>
<li>MarkupSafe 与 Jinja 共用，防止注入攻击</li>
<li>ItsDangerous 保证数据完整性，保护 Flask 的 session、cookie</li>
<li>Click 是一个命令行应用框架。用于提供 Flask 命令，并允许添加自定义管理命令</li>
</ul>
<h3 id="可选依赖"><a href="#可选依赖" class="headerlink" title="可选依赖"></a>可选依赖</h3><ul>
<li>Blinker 为信号提供支持</li>
<li>python-dotenv 当运行 flask 命令时通过 dotenv 设置环境变量提供支持</li>
<li>Warchdog：为开发服务器提供快速高效的重载</li>
</ul>
<h3 id="虚拟环境"><a href="#虚拟环境" class="headerlink" title="虚拟环境"></a>虚拟环境</h3><blockquote>
<p>为每个项目安装单独的 Python 库，隔离不同项目间的 Python 库<br>Python 内置了用于创建虚拟环境的 venv 模块</p>
</blockquote>
<h3 id="创建虚拟环境"><a href="#创建虚拟环境" class="headerlink" title="创建虚拟环境"></a>创建虚拟环境</h3><blockquote>
<p>创建完成后文件夹中会生成一个 venv 文件夹</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 创建</span></span><br><span class="line">python3 -m venv venv</span><br><span class="line"><span class="meta">#</span><span class="bash"> 激活</span></span><br><span class="line">. venv/bin/activate</span><br></pre></td></tr></table></figure>



<h3 id="安装-Flask"><a href="#安装-Flask" class="headerlink" title="安装 Flask"></a>安装 Flask</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install Flask</span><br></pre></td></tr></table></figure>

<h2 id="二、快速上手"><a href="#二、快速上手" class="headerlink" title="二、快速上手"></a>二、快速上手</h2><h3 id="一个最小的应用"><a href="#一个最小的应用" class="headerlink" title="一个最小的应用"></a>一个最小的应用</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/&quot;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hello_world</span>():</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;&lt;p&gt;Hello, World!&lt;/p&gt;&quot;</span></span><br></pre></td></tr></table></figure>
<ol>
<li>导入 Flask，该类的实例会成为 WSGI 应用</li>
<li>使用 route() 指定 http url</li>
<li>接口默认返回 html</li>
</ol>
<p><code>不要使用 flask.py 作为应用名称，会与 Flask 本身冲突</code></p>
<p>运行方式：</p>
<ol>
<li>hello.py  -&gt;  export FLASK_APP=hello  -&gt;  flask run –host=0.0.0.0</li>
<li>app.py(wsgi.py)  -&gt;  flask run –host=0.0.0.0</li>
</ol>
<h3 id="路由"><a href="#路由" class="headerlink" title="路由"></a>路由</h3><blockquote>
<p>使用 route() 装饰器把函数绑定到 URL</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span>():</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;Index Page&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/hello&#x27;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hello</span>():</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;Hello, World&#x27;</span></span><br></pre></td></tr></table></figure>

<h3 id="URL-中使用变量"><a href="#URL-中使用变量" class="headerlink" title="URL 中使用变量"></a>URL 中使用变量</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> markupsafe <span class="keyword">import</span> escape</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/user/&lt;username&gt;&#x27;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show_user_profile</span>(<span class="params">username</span>):</span></span><br><span class="line">    <span class="comment"># show the user profile for that user</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">f&#x27;User <span class="subst">&#123;escape(username)&#125;</span>&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/post/&lt;int:post_id&gt;&#x27;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show_post</span>(<span class="params">post_id</span>):</span></span><br><span class="line">    <span class="comment"># show the post with the given id, the id is an integer</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">f&#x27;Post <span class="subst">&#123;post_id&#125;</span>&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/path/&lt;path:subpath&gt;&#x27;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show_subpath</span>(<span class="params">subpath</span>):</span></span><br><span class="line">    <span class="comment"># show the subpath after /path/</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">f&#x27;Subpath <span class="subst">&#123;escape(subpath)&#125;</span>&#x27;</span></span><br></pre></td></tr></table></figure>

<h3 id="URL-构建"><a href="#URL-构建" class="headerlink" title="URL 构建"></a>URL 构建</h3><blockquote>
<p>url_for() 函数用于</p>
</blockquote>
<h3 id="HTTP-方法"><a href="#HTTP-方法" class="headerlink" title="HTTP 方法"></a>HTTP 方法</h3><blockquote>
<p>Web 应用使用不同的 HTTP 方法处理 URL。缺省情况下，一个路由只回应 GET 请求</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> request</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/login&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">login</span>():</span></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&#x27;POST&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> do_the_login()</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> show_the_login_form()</span><br></pre></td></tr></table></figure>

<h3 id="静态文件"><a href="#静态文件" class="headerlink" title="静态文件"></a>静态文件</h3><p>创建 static 目录，将静态资源放在该目录中</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">url_for(<span class="string">&#x27;static&#x27;</span>, filename=<span class="string">&#x27;style.css&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h3 id="渲染模板"><a href="#渲染模板" class="headerlink" title="渲染模板"></a>渲染模板</h3><blockquote>
<p>使用 render_template() 方法可以渲染模板，只需提供模板名称和作为参数的变量</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> render_template</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/hello/&#x27;</span></span>)</span></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/hello/&lt;name&gt;&#x27;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hello</span>(<span class="params">name=<span class="literal">None</span></span>):</span></span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;hello.html&#x27;</span>, name=name)</span><br></pre></td></tr></table></figure>

<h3 id="请求对象"><a href="#请求对象" class="headerlink" title="请求对象"></a>请求对象</h3><blockquote>
<p>from flask import request</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/login&#x27;</span>, methods=[<span class="string">&#x27;POST&#x27;</span>, <span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">login</span>():</span></span><br><span class="line">    error = <span class="literal">None</span></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&#x27;POST&#x27;</span>:</span><br><span class="line">        <span class="keyword">if</span> valid_login(request.form[<span class="string">&#x27;username&#x27;</span>],</span><br><span class="line">                       request.form[<span class="string">&#x27;password&#x27;</span>]):</span><br><span class="line">            <span class="keyword">return</span> log_the_user_in(request.form[<span class="string">&#x27;username&#x27;</span>])</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            error = <span class="string">&#x27;Invalid username/password&#x27;</span></span><br><span class="line">    <span class="comment"># the code below is executed if the request method</span></span><br><span class="line">    <span class="comment"># was GET or the credentials were invalid</span></span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;login.html&#x27;</span>, error=error)</span><br></pre></td></tr></table></figure>

<h3 id="文件上传"><a href="#文件上传" class="headerlink" title="文件上传"></a>文件上传</h3><blockquote>
<p>表单中设置 enctype=”multipart/form-data”</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> request</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/upload&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">upload_file</span>():</span></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&#x27;POST&#x27;</span>:</span><br><span class="line">        f = request.files[<span class="string">&#x27;the_file&#x27;</span>]</span><br><span class="line">        f.save(<span class="string">&#x27;/var/www/uploads/uploaded_file.txt&#x27;</span>)</span><br><span class="line">    ...</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="cookie"><a href="#cookie" class="headerlink" title="cookie"></a>cookie</h3><p>读取 cookie</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> request</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span>():</span></span><br><span class="line">    username = request.cookies.get(<span class="string">&#x27;username&#x27;</span>)</span><br><span class="line">    <span class="comment"># use cookies.get(key) instead of cookies[key] to not get a</span></span><br><span class="line">    <span class="comment"># KeyError if the cookie is missing.</span></span><br></pre></td></tr></table></figure>

<p>存储 cookie</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> make_response</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span>():</span></span><br><span class="line">    resp = make_response(render_template(...))</span><br><span class="line">    resp.set_cookie(<span class="string">&#x27;username&#x27;</span>, <span class="string">&#x27;the username&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> resp</span><br></pre></td></tr></table></figure>

<h3 id="重定向和错误"><a href="#重定向和错误" class="headerlink" title="重定向和错误"></a>重定向和错误</h3><blockquote>
<p>使用 redirect() 函数可以重定向，使用 abort() 可以更早退出请求，并返回错误码</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> abort, redirect, url_for</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span>():</span></span><br><span class="line">    <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;login&#x27;</span>))</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/login&#x27;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">login</span>():</span></span><br><span class="line">    abort(<span class="number">401</span>)</span><br><span class="line">    this_is_never_executed()</span><br></pre></td></tr></table></figure>

<p>自定义错误页面</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.errorhandler(<span class="params"><span class="number">404</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">page_not_found</span>(<span class="params">error</span>):</span></span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;page_not_found.html&#x27;</span>), <span class="number">404</span></span><br></pre></td></tr></table></figure>

<h3 id="日志"><a href="#日志" class="headerlink" title="日志"></a>日志</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">app.logger.debug(<span class="string">&#x27;A value for debugging&#x27;</span>)</span><br><span class="line">app.logger.warning(<span class="string">&#x27;A warning occurred (%d apples)&#x27;</span>, <span class="number">42</span>)</span><br><span class="line">app.logger.error(<span class="string">&#x27;An error occurred&#x27;</span>)</span><br></pre></td></tr></table></figure>


<p>…</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2017/07/10/python/flask/" data-id="ckvcgyenf000rrsuo1mrz0t7h" data-title="flask" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  


</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/10/">October 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/07/">July 2017</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2021/10/29/java/jvm/">(no title)</a>
          </li>
        
          <li>
            <a href="/2021/10/29/java/juc/">(no title)</a>
          </li>
        
          <li>
            <a href="/2021/10/29/java/java%20se/">(no title)</a>
          </li>
        
          <li>
            <a href="/2021/10/29/framework/spring/">(no title)</a>
          </li>
        
          <li>
            <a href="/2021/10/29/db/redis/">(no title)</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2021 DiGuang Wu<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.4.1.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>